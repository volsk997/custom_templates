{%- set label = 'tg_bot' -%} 
{%- set domains = [
  {'domain': 'light', 'icon_on': 'üü°', 'icon_off': '‚ö™Ô∏è'},
  {'domain': 'switch', 'icon_on': 'üü°', 'icon_off': '‚ö™Ô∏è'},
  {'domain': 'climate', 'icon_off': '‚ö™Ô∏è', 'icon_cool': 'üîµ', 'icon_heat': 'üî¥'},
  {'domain': 'input_boolean', 'icon_on': 'üü°', 'icon_off': '‚ö™Ô∏è'},
  {'domain': 'sensor', 'icon': 'üìà'},
  {'domain': 'media_player', 'icon_playing': 'üîä', 'icon_paused': 'üîá', 'icon_idle': '‚ö™Ô∏è', 'icon_standby': '‚ö´Ô∏è', 'icon_off': '‚ö´Ô∏è'},
  {'domain': 'binary_sensor', 'icon_on': 'üü¢', 'icon_off': '‚ö™Ô∏è'}
] -%}

{# –®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ #}
{%- set ns = namespace(items=[]) -%}

{# –®–∞–≥ 2: –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –¥–æ–º–µ–Ω–∞–º –∏ —Å—É—â–Ω–æ—Å—Ç—è–º #}
{%- for cfg in domains -%}
  {%- for entity_id in label_entities(label) 
     if entity_id.startswith(cfg.domain ~ '.') 
     and entity_id in area_entities(area) -%}

    {# –î–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Ç–µ–∫—Å—Ç #}
    {%- set icon = '' -%}
    {%- set text = '' -%}

    {# –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ #}
    {%- if cfg.domain == 'climate' -%}
      {%- if is_state(entity_id, 'off') -%}{% set icon = cfg.icon_off %}
      {%- elif is_state(entity_id, 'cool') -%}{% set icon = cfg.icon_cool %}
      {%- elif is_state(entity_id, 'heat') -%}{% set icon = cfg.icon_heat %}
      {%- endif -%}
    
    {%- elif cfg.domain == 'media_player' -%}
      {%- if is_state(entity_id, 'playing') -%}{% set icon = cfg.icon_playing %}
      {%- elif is_state(entity_id, 'paused') -%}{% set icon = cfg.icon_paused %}
      {%- elif is_state(entity_id, 'idle') -%}{% set icon = cfg.icon_idle %}
      {%- elif is_state(entity_id, 'standby') -%}{% set icon = cfg.icon_standby %}
      {%- else -%}{% set icon = cfg.icon_off %}
      {%- endif -%}
    
    {%- elif cfg.domain == 'binary_sensor' -%}
      {%- set icon = cfg.icon_on if is_state(entity_id, 'on') else cfg.icon_off -%}
    
    {%- elif 'icon_on' in cfg -%}
      {%- set icon = cfg.icon_on if is_state(entity_id, 'on') else cfg.icon_off -%}
    
    {%- else -%}
      {%- set icon = cfg.icon -%}
    {%- endif -%}

    {# –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ #}
    {%- if cfg.domain == 'sensor' -%}
      {%- set text = state_attr(entity_id, 'friendly_name') ~ ' - ' ~ states(entity_id, with_unit=True) | replace(".",",") | replace("lx","–õ–∫") -%}
    {%- elif cfg.domain == 'media_player' and is_state(entity_id, 'playing') -%}
      {%- set text = state_attr(entity_id, 'friendly_name') ~ ' - ‚ñ∂Ô∏è ' ~ state_attr(entity_id, 'media_title') | default('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', true) -%}
    {%- else -%}
      {%- set text = state_attr(entity_id, 'friendly_name') ~ ' - ' ~ state_translated(entity_id) -%}
    {%- endif -%}

    {# –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ #}
    {%- if not is_state(entity_id, 'unavailable') -%}
      {%- set changed_text = ' (' %}
      {# –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è #}
      {%- set last_changed = as_timestamp(states[entity_id].last_changed) %}
      {%- set now = as_timestamp(now()) %}
      {%- set diff = (now - last_changed) | int %}
      
      {%- if diff < 60 -%}
        {%- set changed_text = changed_text ~ '—Ç–æ–ª—å–∫–æ —á—Ç–æ' -%}
      {%- elif diff < 3600 -%}
        {%- set changed_text = changed_text ~ (diff // 60) | string ~ ' –º–∏–Ω. –Ω–∞–∑–∞–¥' -%}
      {%- elif diff < 86400 -%}
        {%- set changed_text = changed_text ~ (diff // 3600) | string ~ ' —á. –Ω–∞–∑–∞–¥' -%}
      {%- else -%}
        {%- set changed_text = changed_text ~ (diff // 86400) | string ~ ' –¥–Ω. –Ω–∞–∑–∞–¥' -%}
      {%- endif -%}
      
      {%- set changed_text = changed_text ~ ')' -%}
      {%- set text = text ~ changed_text -%}
    {%- endif -%}

    {# –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ø–∏—Å–æ–∫ #}
    {%- set ns.items = ns.items + [{'sort_key': state_attr(entity_id, 'friendly_name') | lower, 'icon': icon, 'text': text}] -%}

  {%- endfor -%}
{%- endfor -%}

{# –®–∞–≥ 3: –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ø–æ –ø–æ–ª—é sort_key) #}
{%- set sorted_items = ns.items | sort(attribute='sort_key') -%}

{# –®–∞–≥ 4: –í—ã–≤–æ–¥–∏–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç #}
{%- for item in sorted_items -%}
{{ item.icon }} {{ item.text }}
{% endfor -%}